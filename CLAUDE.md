# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a CachyOS installation automation repository with Niri window manager configuration. It provides a reproducible setup for CachyOS CLI installations with 201 official packages (system-agnostic), hardware-specific drivers (GPU/CPU automatically detected!), 4 AUR packages (including dms-shell-git), and 14 flatpak applications. The setup uses the Limine bootloader with optional secure boot support. All configurations are hardware-agnostic with no hardcoded settings. Features automatic hardware detection, automatic driver installation, automatic monitor configuration on first run, and DMS lock screen with auto-lock.

## Core Architecture

**Installation Flow:**
The complete installation follows this sequence:
1. **CachyOS CLI Installation**: Install CachyOS as minimal CLI system (no DE) with Limine bootloader
2. **Optional Secure Boot**: Configure secure boot using sbctl (see SECURE_BOOT.md)
3. **Post-Install Script**: The `install.sh` script automatically:
   - Checks for Arch Linux environment (`/etc/arch-release`)
   - Installs AUR helper (paru or yay) if not present
   - Installs packages from official repos (system-agnostic, including SDDM)
   - **Detects hardware** (CPU: AMD/Intel, GPU: NVIDIA/AMD/Intel) and installs appropriate drivers
   - Installs AUR packages (including DMS) and flatpak applications
   - Creates symlinks from `.config/niri/` to `~/.config/niri`
   - **Enables SDDM** display manager to start at boot
4. **First Boot**: After reboot, SDDM starts automatically - select 'niri' from session menu
5. **Monitor Configuration**: Automatically configured on first niri login (can be re-run with Mod+Shift+M)

**Configuration Structure:**
- **Main config**: `.config/niri/config.kdl` - Primary niri configuration (KDL format)
- **Modular configs**: `.config/niri/dms/` - Separated configuration modules (binds, colors, layout, wpblur)
- **Package lists**: Four text files with one package per line (comments start with `#`)
  - `packages-official.txt`: System-agnostic official packages (201)
  - `packages-hardware.txt`: Hardware-specific drivers (reference only - automatically detected!)
  - `packages-aur.txt`: AUR packages (4)
  - `flatpaks.txt`: Flatpak applications (14)
- **Bootloader config**: `/boot/limine.conf` - Auto-generated by limine-entry-tool
- **Bootloader defaults**: `/etc/default/limine` - Kernel parameters configuration

**Bootloader (Limine):**
- **Auto-managed entries**: Kernel entries automatically updated via `limine-mkinitcpio-hook`
- **Secure boot approach**: Only Limine EFI binary needs signing (kernels use BLAKE2B checksum verification)
- **Configuration**: Edit `/etc/default/limine` for kernel parameters, then run `mkinitcpio -P && limine-update`
- **Btrfs snapshots**: Supported via `limine-snapper-sync` (if using Btrfs)

**Secure Boot:**
- Uses `sbctl` for key management and signing
- Only `/boot/EFI/BOOT/BOOTX64.EFI` needs to be signed
- Kernel images do NOT need signing (Limine handles verification internally)
- See `SECURE_BOOT.md` for complete setup guide

**Key Dependencies:**
- **dms-shell-git** (AUR): Custom shell/panel system integrated throughout the niri config
  - Used for: spotlight launcher, clipboard manager, process list, settings, notifications, lock screen
  - All `dms ipc call` commands depend on this being installed and running
- **Multi-monitor setup**: Config hardcoded for 3 monitors (DP-3, HDMI-A-1, DP-2)

## Running Commands

### CachyOS Base Installation
```bash
# 1. Boot from CachyOS installation media
# 2. Run CachyOS CLI installer
# 3. SKIP desktop environment selection
# 4. Select Limine as bootloader
# 5. Complete installation and reboot
```

### Secure Boot Setup (Optional)
```bash
# After booting into minimal CachyOS system
sudo pacman -S sbctl

# Create and enroll keys
sudo sbctl create-keys
sudo sbctl enroll-keys -m  # -m includes Microsoft certificates

# Sign Limine EFI binary
sudo sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI

# Verify signing
sudo sbctl verify

# Enable Secure Boot in UEFI, then verify
sbctl status  # Should show "Secure Boot: Enabled"

# See SECURE_BOOT.md for detailed guide
```

### Post-Install Desktop Setup
```bash
# Clone this repository
git clone <repo-url> ~/niri-setup
cd ~/niri-setup

# Run installation script (automatically detects hardware!)
./install.sh

# The script automatically:
# - Detects CPU (AMD/Intel) and installs microcode
# - Detects GPU(s) (NVIDIA/AMD/Intel) and installs drivers
# - Asks for confirmation before installing hardware drivers
# - Installs AUR helper (paru)
# - Installs all packages (official + AUR + flatpak)
# - Creates config symlinks (backs up existing ~/.config/niri)

# Monitors will be automatically configured on first niri startup!
# Use Mod+Shift+M to re-detect/reconfigure monitors anytime
```

### Testing Configuration

**Niri Configuration:**
```bash
# Validate niri config syntax (run inside niri session)
niri validate ~/.config/niri/config.kdl

# List outputs/monitors for configuration
niri msg outputs

# Check niri logs for errors
journalctl --user -u niri

# Reload niri configuration
niri msg action reload-config
```

**Limine Bootloader:**
```bash
# Update Limine after changing kernel parameters
sudo mkinitcpio -P && sudo limine-update

# View current Limine configuration
cat /boot/limine.conf

# View kernel parameter defaults
cat /etc/default/limine

# Check UEFI boot entries
efibootmgr -v
```

**Secure Boot Status:**
```bash
# Check secure boot status
sbctl status

# List signed files
sudo sbctl list-files

# Verify all enrolled files are signed
sudo sbctl verify
```

### Managing Packages
Package lists use simple text format (one per line, `#` for comments):
- Edit `packages-official.txt` (system-agnostic packages)
- Edit `packages-hardware.txt` (reference only - drivers are auto-detected)
- Edit `packages-aur.txt` (AUR packages)
- Edit `flatpaks.txt` (flatpak applications)
- Re-run `./install.sh` to sync changes
- The `--needed` flag prevents reinstalling existing packages

**Hardware-Specific Packages (Automatic):**
The install script automatically detects and installs hardware drivers:
- **CPU microcode**: Automatically installs `amd-ucode` or `intel-ucode` based on detection
- **NVIDIA GPU**: Automatically installs nvidia-utils, opencl-nvidia, kernel modules, etc.
- **AMD GPU**: Automatically installs vulkan-radeon, xf86-video-amdgpu, etc.
- **Intel GPU**: Automatically installs vulkan-intel, intel-media-driver, etc.
- **Hybrid systems**: Handles multiple GPUs (e.g., Intel iGPU + NVIDIA dGPU)

**Manual Override:**
If automatic detection fails, you can manually uncomment drivers in `packages-hardware.txt` - the script will respect manual configuration.

## Important Configuration Details

**CachyOS Specific:**
- This setup is designed for CachyOS, a performance-optimized Arch-based distribution
- CachyOS provides optimized kernels (linux-cachyos) built with Clang+ThinLTO
- CachyOS repos include additional optimizations and newer package versions

**Bootloader (Limine) Configuration:**
- Kernel entries are auto-managed - no manual editing required
- To change kernel parameters: edit `/etc/default/limine`, then run `mkinitcpio -P && limine-update`
- Config file: `/boot/limine.conf` (auto-generated, don't edit directly)
- For secure boot: only sign `/boot/EFI/BOOT/BOOTX64.EFI`, NOT kernel images

**Monitor Configuration (Automatic):**
- Monitors are **automatically detected and configured** on first niri startup
- Script runs at startup: `.config/niri/scripts/configure-monitors.sh`
- Detects all connected monitors via `niri msg outputs`
- Generates configuration with correct resolutions, refresh rates, and positioning
- Backups config before applying changes
- Manual reconfiguration available via **Mod+Shift+M** keybinding
- Useful for changing display setups, docking/undocking, or updating settings
- Manual editing still supported in `.config/niri/config.kdl` if preferred

**DMS Integration:**
- Most keybindings spawn `dms ipc call` commands
- If dms-shell-git is not installed, keybindings will fail silently
- The system depends on `spawn-at-startup "dms" "run"` (line 140)
- DMS provides: panel, launcher, clipboard, notifications, lock screen
- **Lock Screen**: DMS lock is used for both manual (Mod+Alt+L) and automatic locking
  - Auto-lock after 10 minutes of inactivity (managed by swayidle)
  - Auto-lock before sleep/suspend
  - No separate lock screen package needed (swaylock removed)

**Symlink Behavior:**
- Config changes in `~/.config/niri/` reflect in this repo (bidirectional)
- Original configs backed up to `~/.config/niri.backup.YYYYMMDD_HHMMSS`
- Script removes old symlinks before creating new ones

## Repository Workflow

This repo is designed for:
1. **Fresh CachyOS installs**:
   - Install CachyOS CLI (no DE, Limine bootloader)
   - Optionally configure secure boot
   - Clone repo → run install.sh (auto-detects hardware) → configure monitors → log into Niri
2. **Syncing machines**: Pull changes → run install.sh (auto-detects new machine's hardware) → update monitor config → restart Niri
3. **Config management**: Edit configs anywhere → commit → pull on other machines
4. **Package management**: Edit package lists → run install.sh → changes applied

**Important Notes:**
- Hardware drivers are **automatically detected** - same script works on all machines
- Monitor configuration is **automatically detected** on first niri startup
- The configuration files are completely hardware-agnostic (no hardcoded settings)
- The installation script is idempotent - safe to run multiple times
- System-agnostic packages in `packages-official.txt` can be shared across all machines
- `packages-hardware.txt` is now a reference file - automatic detection handles driver installation
- Monitor detection script can be manually triggered with Mod+Shift+M

## Additional Documentation

- **SECURE_BOOT.md**: Comprehensive guide for setting up secure boot with Limine
- **README.md**: User-facing quick start and installation guide
- **packages-*.txt**: Package lists with comments explaining purpose
