# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a CachyOS installation automation repository with Niri window manager configuration. It provides a reproducible setup for CachyOS CLI installations with ~200 official packages (system-agnostic), hardware-specific drivers (GPU/CPU configured per system), 6 AUR packages (including dms-shell-git), and 7 flatpak applications. The setup uses the Limine bootloader with optional secure boot support.

## Core Architecture

**Installation Flow:**
The complete installation follows this sequence:
1. **CachyOS CLI Installation**: Install CachyOS as minimal CLI system (no DE) with Limine bootloader
2. **Optional Secure Boot**: Configure secure boot using sbctl (see SECURE_BOOT.md)
3. **Hardware Configuration**: Edit `packages-hardware.txt` to uncomment GPU/CPU drivers for YOUR system
4. **Post-Install Script**: The `install.sh` script then:
   - Checks for Arch Linux environment (`/etc/arch-release`)
   - Installs AUR helper (paru or yay) if not present
   - Installs packages from four sources: official repos (system-agnostic), hardware-specific drivers, AUR (including DMS), flatpak
   - Creates symlinks from `.config/niri/` to `~/.config/niri`
5. **Monitor Configuration**: Edit `.config/niri/config.kdl` lines 8-24 to match YOUR display setup

**Configuration Structure:**
- **Main config**: `.config/niri/config.kdl` - Primary niri configuration (KDL format)
- **Modular configs**: `.config/niri/dms/` - Separated configuration modules (binds, colors, layout, wpblur)
- **Package lists**: Four text files with one package per line (comments start with `#`)
  - `packages-official.txt`: System-agnostic official packages (~200)
  - `packages-hardware.txt`: Hardware-specific drivers (GPU/CPU - MUST be configured per system!)
  - `packages-aur.txt`: AUR packages (6)
  - `flatpaks.txt`: Flatpak applications (7)
- **Bootloader config**: `/boot/limine.conf` - Auto-generated by limine-entry-tool
- **Bootloader defaults**: `/etc/default/limine` - Kernel parameters configuration

**Bootloader (Limine):**
- **Auto-managed entries**: Kernel entries automatically updated via `limine-mkinitcpio-hook`
- **Secure boot approach**: Only Limine EFI binary needs signing (kernels use BLAKE2B checksum verification)
- **Configuration**: Edit `/etc/default/limine` for kernel parameters, then run `mkinitcpio -P && limine-update`
- **Btrfs snapshots**: Supported via `limine-snapper-sync` (if using Btrfs)

**Secure Boot:**
- Uses `sbctl` for key management and signing
- Only `/boot/EFI/BOOT/BOOTX64.EFI` needs to be signed
- Kernel images do NOT need signing (Limine handles verification internally)
- See `SECURE_BOOT.md` for complete setup guide

**Key Dependencies:**
- **dms-shell-git** (AUR): Custom shell/panel system integrated throughout the niri config
  - Used for: spotlight launcher, clipboard manager, process list, settings, notifications, lock screen
  - All `dms ipc call` commands depend on this being installed and running
- **Multi-monitor setup**: Config hardcoded for 3 monitors (DP-3, HDMI-A-1, DP-2)

## Running Commands

### CachyOS Base Installation
```bash
# 1. Boot from CachyOS installation media
# 2. Run CachyOS CLI installer
# 3. SKIP desktop environment selection
# 4. Select Limine as bootloader
# 5. Complete installation and reboot
```

### Secure Boot Setup (Optional)
```bash
# After booting into minimal CachyOS system
sudo pacman -S sbctl

# Create and enroll keys
sudo sbctl create-keys
sudo sbctl enroll-keys -m  # -m includes Microsoft certificates

# Sign Limine EFI binary
sudo sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI

# Verify signing
sudo sbctl verify

# Enable Secure Boot in UEFI, then verify
sbctl status  # Should show "Secure Boot: Enabled"

# See SECURE_BOOT.md for detailed guide
```

### Post-Install Desktop Setup
```bash
# Clone this repository
git clone <repo-url> ~/niri-setup
cd ~/niri-setup

# CRITICAL: Configure hardware drivers FIRST!
# Identify your hardware
cat /proc/cpuinfo | grep vendor  # Check CPU (AMD or Intel)
lspci | grep -E "VGA|3D"         # Check GPU (NVIDIA, AMD, Intel)

# Edit packages-hardware.txt and uncomment YOUR drivers
nano packages-hardware.txt

# Run installation script
./install.sh

# The script handles:
# - AUR helper installation (paru)
# - Package installation (official + hardware-specific + AUR + flatpak)
# - Niri, Wayland, and DMS installation
# - Config symlink creation (backs up existing ~/.config/niri)

# IMPORTANT: Configure monitors for YOUR setup
# Default config has hardcoded triple-monitor setup (lines 8-24)
nano .config/niri/config.kdl
# After starting niri, find your monitor names with: niri msg outputs
```

### Testing Configuration

**Niri Configuration:**
```bash
# Validate niri config syntax (run inside niri session)
niri validate ~/.config/niri/config.kdl

# List outputs/monitors for configuration
niri msg outputs

# Check niri logs for errors
journalctl --user -u niri

# Reload niri configuration
niri msg action reload-config
```

**Limine Bootloader:**
```bash
# Update Limine after changing kernel parameters
sudo mkinitcpio -P && sudo limine-update

# View current Limine configuration
cat /boot/limine.conf

# View kernel parameter defaults
cat /etc/default/limine

# Check UEFI boot entries
efibootmgr -v
```

**Secure Boot Status:**
```bash
# Check secure boot status
sbctl status

# List signed files
sudo sbctl list-files

# Verify all enrolled files are signed
sudo sbctl verify
```

### Managing Packages
Package lists use simple text format (one per line, `#` for comments):
- Edit `packages-official.txt` (system-agnostic packages)
- Edit `packages-hardware.txt` (GPU/CPU drivers - uncomment for YOUR hardware)
- Edit `packages-aur.txt` (AUR packages)
- Edit `flatpaks.txt` (flatpak applications)
- Re-run `./install.sh` to sync changes
- The `--needed` flag prevents reinstalling existing packages

**Hardware-Specific Packages:**
The `packages-hardware.txt` file contains GPU and CPU drivers commented out by default. You MUST uncomment the lines matching your hardware:
- CPU microcode: `amd-ucode` OR `intel-ucode`
- NVIDIA GPU: nvidia-utils, lib32-nvidia-utils, opencl-nvidia, etc.
- AMD GPU: vulkan-radeon, lib32-vulkan-radeon, xf86-video-amdgpu
- Intel GPU: vulkan-intel, lib32-vulkan-intel, intel-media-driver

## Important Configuration Details

**CachyOS Specific:**
- This setup is designed for CachyOS, a performance-optimized Arch-based distribution
- CachyOS provides optimized kernels (linux-cachyos) built with Clang+ThinLTO
- CachyOS repos include additional optimizations and newer package versions

**Bootloader (Limine) Configuration:**
- Kernel entries are auto-managed - no manual editing required
- To change kernel parameters: edit `/etc/default/limine`, then run `mkinitcpio -P && limine-update`
- Config file: `/boot/limine.conf` (auto-generated, don't edit directly)
- For secure boot: only sign `/boot/EFI/BOOT/BOOTX64.EFI`, NOT kernel images

**Monitor Configuration (`.config/niri/config.kdl:9-24`):**
- Triple monitor setup is hardcoded for specific outputs (DP-3, HDMI-A-1, DP-2)
- **CRITICAL**: When deploying to different hardware, update output names and positions
- This is a REQUIRED configuration step for new installations
- Find your output names with: `niri msg outputs` (run inside niri session)
- Update lines 8-24 in config.kdl with YOUR monitor names, resolutions, and positions
- Reload config with: `niri msg action reload-config`

**DMS Integration:**
- Most keybindings spawn `dms ipc call` commands
- If dms-shell-git is not installed, keybindings will fail silently
- The system depends on `spawn-at-startup "dms" "run"` (line 132)
- DMS provides: panel, launcher, clipboard, notifications, lock screen

**Symlink Behavior:**
- Config changes in `~/.config/niri/` reflect in this repo (bidirectional)
- Original configs backed up to `~/.config/niri.backup.YYYYMMDD_HHMMSS`
- Script removes old symlinks before creating new ones

## Repository Workflow

This repo is designed for:
1. **Fresh CachyOS installs**:
   - Install CachyOS CLI (no DE, Limine bootloader)
   - Optionally configure secure boot
   - Clone repo → configure hardware drivers in packages-hardware.txt → run install.sh → configure monitors → log into Niri
2. **Syncing machines**: Pull changes → review packages-hardware.txt for new machine → run install.sh → update monitor config → restart Niri
3. **Config management**: Edit configs anywhere → commit → pull on other machines
4. **Package management**: Edit package lists → run install.sh → changes applied

**Important Notes:**
- `packages-hardware.txt` is machine-specific - you may need different drivers on different machines
- Monitor configuration in config.kdl is also machine-specific
- The installation script is idempotent - safe to run multiple times
- System-agnostic packages in `packages-official.txt` can be shared across all machines

## Additional Documentation

- **SECURE_BOOT.md**: Comprehensive guide for setting up secure boot with Limine
- **README.md**: User-facing quick start and installation guide
- **packages-*.txt**: Package lists with comments explaining purpose
