# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a CachyOS installation automation repository with Niri window manager configuration. It provides a reproducible setup for CachyOS CLI installations with 208 official packages, 6 AUR packages (including dms-shell-git), and 7 flatpak applications. The setup uses the Limine bootloader with optional secure boot support.

## Core Architecture

**Installation Flow:**
The complete installation follows this sequence:
1. **CachyOS CLI Installation**: Install CachyOS as minimal CLI system (no DE) with Limine bootloader
2. **Optional Secure Boot**: Configure secure boot using sbctl (see SECURE_BOOT.md)
3. **Post-Install Script**: The `install.sh` script then:
   - Checks for Arch Linux environment (`/etc/arch-release`)
   - Installs AUR helper (paru or yay) if not present
   - Installs packages from three sources: official repos (including Niri, Wayland), AUR (including DMS), flatpak
   - Creates symlinks from `.config/niri/` to `~/.config/niri`

**Configuration Structure:**
- **Main config**: `.config/niri/config.kdl` - Primary niri configuration (KDL format)
- **Modular configs**: `.config/niri/dms/` - Separated configuration modules (binds, colors, layout, wpblur)
- **Package lists**: Three text files with one package per line (comments start with `#`)
- **Bootloader config**: `/boot/limine.conf` - Auto-generated by limine-entry-tool
- **Bootloader defaults**: `/etc/default/limine` - Kernel parameters configuration

**Bootloader (Limine):**
- **Auto-managed entries**: Kernel entries automatically updated via `limine-mkinitcpio-hook`
- **Secure boot approach**: Only Limine EFI binary needs signing (kernels use BLAKE2B checksum verification)
- **Configuration**: Edit `/etc/default/limine` for kernel parameters, then run `mkinitcpio -P && limine-update`
- **Btrfs snapshots**: Supported via `limine-snapper-sync` (if using Btrfs)

**Secure Boot:**
- Uses `sbctl` for key management and signing
- Only `/boot/EFI/BOOT/BOOTX64.EFI` needs to be signed
- Kernel images do NOT need signing (Limine handles verification internally)
- See `SECURE_BOOT.md` for complete setup guide

**Key Dependencies:**
- **dms-shell-git** (AUR): Custom shell/panel system integrated throughout the niri config
  - Used for: spotlight launcher, clipboard manager, process list, settings, notifications, lock screen
  - All `dms ipc call` commands depend on this being installed and running
- **Multi-monitor setup**: Config hardcoded for 3 monitors (DP-3, HDMI-A-1, DP-2)

## Running Commands

### CachyOS Base Installation
```bash
# 1. Boot from CachyOS installation media
# 2. Run CachyOS CLI installer
# 3. SKIP desktop environment selection
# 4. Select Limine as bootloader
# 5. Complete installation and reboot
```

### Secure Boot Setup (Optional)
```bash
# After booting into minimal CachyOS system
sudo pacman -S sbctl

# Create and enroll keys
sudo sbctl create-keys
sudo sbctl enroll-keys -m  # -m includes Microsoft certificates

# Sign Limine EFI binary
sudo sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI

# Verify signing
sudo sbctl verify

# Enable Secure Boot in UEFI, then verify
sbctl status  # Should show "Secure Boot: Enabled"

# See SECURE_BOOT.md for detailed guide
```

### Post-Install Desktop Setup
```bash
# Clone this repository and run installation script
git clone <repo-url> ~/niri-setup
cd ~/niri-setup
./install.sh

# The script handles:
# - AUR helper installation (paru)
# - Package installation (official + AUR + flatpak)
# - Niri, Wayland, and DMS installation
# - Config symlink creation (backs up existing ~/.config/niri)
```

### Testing Configuration

**Niri Configuration:**
```bash
# Validate niri config syntax (run inside niri session)
niri validate ~/.config/niri/config.kdl

# List outputs/monitors for configuration
niri msg outputs

# Check niri logs for errors
journalctl --user -u niri

# Reload niri configuration
niri msg action reload-config
```

**Limine Bootloader:**
```bash
# Update Limine after changing kernel parameters
sudo mkinitcpio -P && sudo limine-update

# View current Limine configuration
cat /boot/limine.conf

# View kernel parameter defaults
cat /etc/default/limine

# Check UEFI boot entries
efibootmgr -v
```

**Secure Boot Status:**
```bash
# Check secure boot status
sbctl status

# List signed files
sudo sbctl list-files

# Verify all enrolled files are signed
sudo sbctl verify
```

### Managing Packages
Package lists use simple text format (one per line, `#` for comments):
- Edit `packages-official.txt`, `packages-aur.txt`, or `flatpaks.txt`
- Re-run `./install.sh` to sync changes
- The `--needed` flag prevents reinstalling existing packages

## Important Configuration Details

**CachyOS Specific:**
- This setup is designed for CachyOS, a performance-optimized Arch-based distribution
- CachyOS provides optimized kernels (linux-cachyos) built with Clang+ThinLTO
- CachyOS repos include additional optimizations and newer package versions

**Bootloader (Limine) Configuration:**
- Kernel entries are auto-managed - no manual editing required
- To change kernel parameters: edit `/etc/default/limine`, then run `mkinitcpio -P && limine-update`
- Config file: `/boot/limine.conf` (auto-generated, don't edit directly)
- For secure boot: only sign `/boot/EFI/BOOT/BOOTX64.EFI`, NOT kernel images

**Monitor Configuration (`.config/niri/config.kdl:9-24`):**
- Triple monitor setup is hardcoded for specific outputs
- When deploying to different hardware, update output names and positions
- Find your output names with: `niri msg outputs`

**DMS Integration:**
- Most keybindings spawn `dms ipc call` commands
- If dms-shell-git is not installed, keybindings will fail silently
- The system depends on `spawn-at-startup "dms" "run"` (line 132)
- DMS provides: panel, launcher, clipboard, notifications, lock screen

**Symlink Behavior:**
- Config changes in `~/.config/niri/` reflect in this repo (bidirectional)
- Original configs backed up to `~/.config/niri.backup.YYYYMMDD_HHMMSS`
- Script removes old symlinks before creating new ones

## Repository Workflow

This repo is designed for:
1. **Fresh CachyOS installs**:
   - Install CachyOS CLI (no DE, Limine bootloader)
   - Optionally configure secure boot
   - Clone repo → run install.sh → log into Niri
2. **Syncing machines**: Pull changes → run install.sh → restart Niri
3. **Config management**: Edit configs anywhere → commit → pull on other machines
4. **Package management**: Edit package lists → run install.sh → changes applied

The installation script is idempotent - safe to run multiple times.

## Additional Documentation

- **SECURE_BOOT.md**: Comprehensive guide for setting up secure boot with Limine
- **README.md**: User-facing quick start and installation guide
- **packages-*.txt**: Package lists with comments explaining purpose
